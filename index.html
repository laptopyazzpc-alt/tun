<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesture + Efek Darah Dramatis</title>
<style>
  body { margin:0; overflow:hidden; background:#000; display:flex; justify-content:center; align-items:center; height:100vh; }
  canvas { position:absolute; top:0; left:0; }
  video { display:none; }
  #startBtn {
    position:absolute;
    z-index:10;
    padding:10px 20px;
    font-size:18px;
    cursor:pointer;
  }
  #status {
    position:absolute;
    bottom:10px;
    left:10px;
    color:white;
    font-family:monospace;
    font-size:14px;
  }
</style>
</head>
<body>
<button id="startBtn">Start</button>
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="status">Status: Menunggu...</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const statusBar = document.getElementById('status');
let lastSpeechTime = 0;
const cooldown = 2000;

// Resize otomatis
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// Web Speech API
const synth = window.speechSynthesis;
function speak(text){
    if(!synth.speaking){
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "id-ID";
        utter.rate = 1;
        utter.pitch = 1;
        synth.speak(utter);
    }
}

// Partikel darah
let particles = [];
function spawnParticle(x,y){
    particles.push({
        x,y,
        vx:(Math.random()-0.5)*2,
        vy:Math.random()*2+1,
        alpha:1,
        size:Math.random()*4+2
    });
}
function updateParticles(){
    particles.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.alpha -= 0.02;
    });
    particles = particles.filter(p=>p.alpha>0);
}
function drawParticles(){
    particles.forEach(p=>{
        ctx.fillStyle = `rgba(200,0,0,${p.alpha})`;
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        ctx.fill();
    });
}

// MediaPipe Hands
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({
    maxNumHands: 2,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
});

// Efek garis darah dengan glow + partikel
function drawBloodLines(landmarks){
    const connections = [
        [0,1],[1,2],[2,3],[3,4],
        [0,5],[5,6],[6,7],[7,8],
        [0,9],[9,10],[10,11],[11,12],
        [0,13],[13,14],[14,15],[15,16],
        [0,17],[17,18],[18,19],[19,20]
    ];

    connections.forEach(([i,j]) => {
        const x1 = canvas.width - landmarks[i].x * canvas.width;
        const y1 = landmarks[i].y * canvas.height;
        const x2 = canvas.width - landmarks[j].x * canvas.width;
        const y2 = landmarks[j].y * canvas.height;
        const mx = (x1 + x2)/2 + (Math.random()-0.5)*6;
        const my = (y1 + y2)/2 + (Math.random()-0.5)*6;

        // Garis glow merah
        ctx.strokeStyle = "red";
        ctx.lineWidth = 3;
        ctx.shadowColor = "red";
        ctx.shadowBlur = 20;
        ctx.beginPath();
        ctx.moveTo(x1,y1);
        ctx.quadraticCurveTo(mx,my,x2,y2);
        ctx.stroke();
        ctx.shadowBlur = 0;

        // Spawn partikel di tengah garis
        spawnParticle(mx,my);
    });
}

// Status jari
function getFingers(landmarks){
    const thumb = landmarks[4].x < landmarks[3].x ? 1 : 0;
    const fingers = [8,12,16,20].map(i => landmarks[i].y < landmarks[i-2].y ? 1 : 0);
    return [thumb,...fingers];
}

// Gesture
function detectGesture(handLabel, fingers){
    const now = Date.now();
    if(now - lastSpeechTime < cooldown) return;

    if(handLabel==="Right" && fingers.every(f=>f===1)){
        speak("Halo"); lastSpeechTime = now;
        statusBar.textContent = "Status: Gesture HALO";
    }
    else if(handLabel==="Right" && fingers[1]==1 && fingers.slice(0,1).concat(fingers.slice(2)).every(f=>f===0)){
        speak("Nama saya"); lastSpeechTime = now;
        statusBar.textContent = "Status: Gesture NAMA SAYA";
    }
    else if(handLabel==="Right" && fingers[0]==1 && fingers.slice(1).every(f=>f===0)){
        speak("Bara"); lastSpeechTime = now;
        statusBar.textContent = "Status: Gesture BARA";
    }
    else if(handLabel==="Right" && fingers[1]==1 && fingers[2]==1 && fingers[0]==0 && fingers[3]==0 && fingers[4]==0){
        speak("Sampai jumpa"); lastSpeechTime = now;
        statusBar.textContent = "Status: Gesture SAMPAI JUMPA";
    }
    else if(handLabel==="Left" && fingers[0]==0 && fingers.slice(1).every(f=>f===1)){
        speak("Love you"); lastSpeechTime = now;
        statusBar.textContent = "Status: Gesture LOVE YOU";
    }
}

// Hasil deteksi
hands.onResults(results => {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(video.readyState >= 2){
        ctx.save();
        ctx.scale(-1,1);
        ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
        ctx.restore();
    }

    if(results.multiHandLandmarks && results.multiHandedness){
        results.multiHandLandmarks.forEach((landmarks,index)=>{
            drawBloodLines(landmarks);
            const fingers = getFingers(landmarks);
            const handLabel = results.multiHandedness[index].label;
            detectGesture(handLabel,fingers);
        });
    } else {
        statusBar.textContent = "Status: Tidak ada tangan";
    }

    updateParticles();
    drawParticles();
});

// Loop
async function detectHands(){
    if(video.readyState >= 2){
        await hands.send({image: video});
    }
    requestAnimationFrame(detectHands);
}

// Start button
startBtn.addEventListener('click', async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    video.addEventListener('loadeddata', () => {
        detectHands();
    });

    speak("Sistem siap!");
    statusBar.textContent = "Status: Sistem siap!";
    startBtn.style.display = 'none';
});
</script>
</body>
</html>
