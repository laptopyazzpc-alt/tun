<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesture + Efek Darah Realistis</title>
<style>
  body { margin:0; overflow:hidden; background:#000; display:flex; justify-content:center; align-items:center; height:100vh; }
  canvas { position:absolute; top:0; left:0; }
  video { display:none; }
  #startBtn {
    position:absolute;
    z-index:10;
    padding:10px 20px;
    font-size:18px;
    cursor:pointer;
  }
</style>
</head>
<body>
<button id="startBtn">Start</button>
<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
let lastSpeechTime = 0;
const cooldown = 2000;

// Web Speech API
const synth = window.speechSynthesis;
function speak(text){
    if(!synth.speaking){
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1;
        utter.pitch = 1;
        synth.speak(utter);
        console.log("Speech triggered:", text);
    }
}

// Start button
startBtn.addEventListener('click', async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    video.addEventListener('loadeddata', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        detectHands();
    });

    speak("Sistem siap!");
    startBtn.style.display = 'none';
});

// MediaPipe Hands
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({
    maxNumHands: 2,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
});

// Garis darah rapi & hidup
function drawBloodLines(landmarks){
    const connections = [
        [0,1],[1,2],[2,3],[3,4],
        [0,5],[5,6],[6,7],[7,8],
        [0,9],[9,10],[10,11],[11,12],
        [0,13],[13,14],[14,15],[15,16],
        [0,17],[17,18],[18,19],[19,20]
    ];

    ctx.strokeStyle = "red";
    ctx.lineWidth = 4;
    ctx.lineCap = "round";

    connections.forEach(([i,j]) => {
        const x1 = landmarks[i].x*canvas.width;
        const y1 = landmarks[i].y*canvas.height;
        const x2 = landmarks[j].x*canvas.width;
        const y2 = landmarks[j].y*canvas.height;

        const mx = (x1 + x2)/2 + (Math.random()-0.5)*8;
        const my = (y1 + y2)/2 + (Math.random()-0.5)*8;

        ctx.beginPath();
        ctx.moveTo(x1,y1);
        ctx.quadraticCurveTo(mx,my,x2,y2);
        ctx.stroke();
    });
}

// Status jari
function getFingers(landmarks){
    const thumb = landmarks[4].x < landmarks[3].x ? 1 : 0; // kanan tetap kanan layar
    const fingers = [8,12,16,20].map(i => landmarks[i].y < landmarks[i-2].y ? 1 : 0);
    return [thumb,...fingers];
}

// Gesture realistis
function detectGesture(handLabel, fingers){
    const now = Date.now();
    if(now - lastSpeechTime < cooldown) return;

    if(handLabel==="Right" && fingers.every(f=>f===1)){
        speak("Halo");
        lastSpeechTime = now;
    }
    else if(handLabel==="Right" && fingers[1]==1 && fingers.slice(0,1).concat(fingers.slice(2)).every(f=>f===0)){
        speak("Nama saya");
        lastSpeechTime = now;
    }
    else if(handLabel==="Right" && fingers[0]==1 && fingers.slice(1).every(f=>f===0)){
        speak("Bara");
        lastSpeechTime = now;
    }
    else if(handLabel==="Right" && fingers[1]==1 && fingers[2]==1 && fingers[0]==0 && fingers[3]==0 && fingers[4]==0){
        speak("Sampai jumpa");
        lastSpeechTime = now;
    }
    else if(handLabel==="Left" && fingers[0]==0 && fingers[1]==1 && fingers[2]==1 && fingers[3]==1 && fingers[4]==1){
        speak("Love you");
        lastSpeechTime = now;
    }
}

// Hasil deteksi MediaPipe
hands.onResults(results => {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(video.readyState >= 2){
        // Balik horizontal canvas supaya tangan kanan tetap kanan layar
        ctx.save();
        ctx.scale(-1,1);
        ctx.drawImage(video, -canvas.width,0,canvas.width,canvas.height);
        ctx.restore();
    }

    if(results.multiHandLandmarks && results.multiHandedness){
        results.multiHandLandmarks.forEach((landmarks,index)=>{
            drawBloodLines(landmarks);
            const fingers = getFingers(landmarks);
            const handLabel = results.multiHandedness[index].label;
            detectGesture(handLabel,fingers);
        });
    }
});

// Looping frame
async function detectHands(){
    if(video.readyState >= 2){
        await hands.send({image: video});
    }
    requestAnimationFrame(detectHands);
}
</script>
</body>
</html>
